<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Product Management</h2>
        
        <!-- Search Bar -->
        <form method="GET" action="/adminPanel/products" class="form-inline mb-3">
            <div class="form-group mr-2">
                <input type="text" name="search" class="form-control" placeholder="Search by name" value="<%= search %>">
            </div>
            <button type="submit" class="btn btn-success">Search</button>
        </form>

        <!-- Add Product Button -->
        <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#addProductModal">
            Add Product
        </button>

        <!-- Product Table -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Category</th>
                    <th>Stock Quantity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% if (products.length > 0) { %>
                    <% products.forEach(function(product) { %>
                        <tr>
                            <td>
                                <% if (product.images && product.images.length > 0) { %>
                                    <% let imagePath = product.images[0].split('\\').pop().split('/').pop(); %> <!-- Handles both slashes -->
                                    <img src="/<%= imagePath %>" alt="Product Image" class="img-thumbnail" style="width: 100px; height: 100px;">
                                <% } else { %>
                                    <img src="/<%= product.images %>" alt="Product Image" class="img-thumbnail" style="width: 100px; height: 100px;">
                                <% } %>
                            </td>                                       
                            
                            <td><%= product.name %></td>
                            <td><%= product.description %></td>
                            <td><%= product.price %></td>
                            <td><%= product.category.name %></td>
                            <td><%= product.stock %></td>
                            <td>
                                <!-- Edit Product Button -->
                                <button type="button" class="btn btn-warning btn-sm" data-toggle="modal" data-target="#editProductModal<%= product._id %>">
                                    Edit
                                </button>

                                <!-- Edit Product Modal -->
                                <div class="modal fade" id="editProductModal<%= product._id %>" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel<%= product._id %>" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="editProductModalLabel<%= product._id %>">Edit Product</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <form action="/adminPanel/products/edit/<%= product._id %>" method="POST" enctype="multipart/form-data">
                                                <div class="modal-body">
                                                    <!-- Form fields -->
                                                    <div class="form-group">
                                                        <label for="productName">Product Name</label>
                                                        <input type="text" name="name" class="form-control" value="<%= product.name %>" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="productDescription">Description</label>
                                                        <textarea name="description" class="form-control" required><%= product.description %></textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="productPrice">Price</label>
                                                        <input type="number" name="price" class="form-control" value="<%= product.price %>" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="productCategory">Category</label>
                                                        <select name="category" class="form-control" required>
                                                            <% categories.forEach(function(category) { %>
                                                                <option value="<%= category._id %>" <%= product.category._id.equals(category._id) ? 'selected' : '' %>><%= category.name %></option>
                                                            <% }); %>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="productStock">Stock Quantity</label>
                                                        <input type="number" name="stockQuantity" class="form-control" value="<%= product.stock %>" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="productStatus">Stock Status</label>
                                                        <select name="stockStatus" class="form-control" required>
                                                            <option value="In Stock" <%= product.stockStatus === 'In Stock' ? 'selected' : '' %>>In Stock</option>
                                                            <option value="Out of Stock" <%= product.stockStatus === 'Out of Stock' ? 'selected' : '' %>>Out of Stock</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="images">Product Images:</label>
                                                        <% if (product.images && product.images.length > 0) { %>
                                                            <div class="image-preview">
                                                                <% product.images.forEach(function(image) { %>
                                                                    <% let imagePath = image.split('\\').pop().split('/').pop(); %>
                                                                    <img src="/<%= imagePath %>" alt="Product Image" class="img-thumbnail" style="width: 100px; height: 100px;">
                                                                <% }) %>
                                                            </div>
                                                        <% } else { %>
                                                            <p>No images uploaded yet.</p>
                                                        <% } %>
                                                        <input type="file" name="images" id="images" accept="image/*" multiple>
                                                    </div>
                                                    <div id="crop-container" style="display: none;">
                                                        <img id="imagePreview" style="max-width: 100%;" />
                                                        <button type="button" id="cropImageButton" class="btn btn-primary">Crop Image</button>
                                                    </div>
                                                    
                                                    <!-- Canvas to hold the cropped image -->
                                                    <canvas id="canvas" style="display: none;"></canvas>
                                                
                                                    <!-- Thumbnails for the cropped images -->
                                                    <div id="croppedImagesContainer"></div>
                                                    <small class="text-muted">Note: You must upload at least 3 images.</small>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary">Save changes</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Toggle Product Status -->
                                <form action="/adminPanel/products/toggle-status/<%= product._id %>" method="POST" style="display:inline;">
                                    <button type="button" class="btn btn-sm <%= product.isDelete ? 'btn-success' : 'btn-danger' %>" onclick="this.form.submit();">
                                        <%= product.isDelete ? "Restore" : "Delete" %>
                                    </button>
                                </form>
                                
                            </td>
                        </tr>
                    <% }); %>
                <% } else { %>
                    <tr>
                        <td colspan="7">No products found</td>
                    </tr>
                <% } %>
            </tbody>
        </table>

        <!-- Pagination -->
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center">
                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                    <a class="page-link" href="/adminPanel/products?page=<%= currentPage - 1 %>&search=<%= search %>" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                        <a class="page-link" href="/adminPanel/products?page=<%= i %>&search=<%= search %>"><%= i %></a>
                    </li>
                <% } %>
                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                    <a class="page-link" href="/adminPanel/products?page=<%= currentPage + 1 %>&search=<%= search %>" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Add Product</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/adminPanel/products/add" method="POST" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="productName">Product Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="productDescription">Description</label>
                            <textarea name="description" class="form-control" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Price</label>
                            <input type="number" name="price" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Category</label>
                            <select name="category" class="form-control" required>
                                <% categories.forEach(function(category) { %>
                                    <option value="<%= category._id %>"><%= category.name %></option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="productStock">Stock Quantity</label>
                            <input type="number" name="stockQuantity" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="productStatus">Stock Status</label>
                            <select name="stockStatus" class="form-control" required>
                                <option value="In Stock">In Stock</option>
                                <option value="Out of Stock">Out of Stock</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="images">Product Images:</label>
                            <input type="file" name="images" id="images" accept="image/*" multiple required>
                        </div>
                        <small class="text-muted">Note: You must upload at least 3 images.</small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
            $('#addProductForm').on('submit', function(e) {
                e.preventDefault(); // Prevent the default form submission
        
                const formData = new FormData(this); // Create a FormData object from the form
        
                $.ajax({
                    url: '/adminPanel/add', // The endpoint for your POST request
                    type: 'POST',
                    data: formData,
                    contentType: false, // Important for file uploads
                    processData: false, // Important for file uploads
                    success: function(response) {
                        // Handle success response (e.g., close modal and refresh table)
                        $('#addProductModal').modal('hide'); // Assuming you have a modal for adding products
                        // Call a function to refresh the product table
                        refreshProductTable();
                    },
                    error: function(err) {
                        console.error(err);
                        alert('Error adding product');
                    }
                });
            });
        });
        
        // Function to refresh the product table
        function refreshProductTable() {
            // Use AJAX to fetch the updated product list and update the table
            $.ajax({
                url: '/adminPanel/products', // Adjust this based on how you get the products
                method: 'GET',
                success: function(data) {
                    // Update your table with the new product list (you may need to modify this)
                    $('#productTableBody').html(data); // Assuming you have a table body to populate
                },
                error: function(err) {
                    console.error('Failed to fetch updated products', err);
                }
            });
        }


        const imageInput = document.getElementById('images');
const imagePreview = document.getElementById('imagePreview');
const cropContainer = document.getElementById('crop-container');
const croppedImagesContainer = document.getElementById('croppedImagesContainer');
const canvas = document.getElementById('canvas');
let cropper;
let imageFiles = [];
let croppedImages = [];

imageInput.addEventListener('change', function(event) {
    imageFiles = Array.from(event.target.files);

    if (imageFiles.length >= 3) {
        loadAndCropImage(0);
    } else {
        alert("Please select at least 3 images.");
    }
});

function loadAndCropImage(index) {
    const file = imageFiles[index];
    const reader = new FileReader();

    reader.onload = function(e) {
        imagePreview.src = e.target.result;
        cropContainer.style.display = 'block';

        if (cropper) {
            cropper.destroy();
        }

        cropper = new Cropper(imagePreview, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
            crop: function(event) {
                // Optionally add crop event logic here
            }
        });
    };

    reader.readAsDataURL(file);
}

document.getElementById('cropImageButton').addEventListener('click', function() {
    const croppedCanvas = cropper.getCroppedCanvas({
        width: 500,
        height: 500
    });

    croppedCanvas.toBlob((blob) => {
        croppedImages.push(blob);

        const imgElement = document.createElement('img');
        imgElement.src = croppedCanvas.toDataURL();
        imgElement.style.width = '100px';
        imgElement.style.height = '100px';
        imgElement.classList.add('img-thumbnail');
        croppedImagesContainer.appendChild(imgElement);

        // Move on to the next image
        if (croppedImages.length < imageFiles.length) {
            loadAndCropImage(croppedImages.length);
        } else {
            cropContainer.style.display = 'none'; // Hide crop container after all images
        }
    });
});

// Modify the form submission to include cropped images
document.querySelector('form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const formData = new FormData(this);

    croppedImages.forEach((croppedImage, index) => {
        formData.append('images', croppedImage, `croppedImage${index}.png`);
    });

    // Submit the form data
    fetch('/adminPanel/products/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        // Handle success (e.g., close modal and refresh table)
        $('#addProductModal').modal('hide');
        refreshProductTable();
    })
    .catch(error => console.error('Error:', error));
});




    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</body>
</html>
